networks:
  lifestrands-network:
    driver: bridge

volumes:
  postgres-data:
    driver: local
  redis-data:
    driver: local
  models-data:
    driver: local
  logs-data:
    driver: local

services:
  # ================================
  # Database Services
  # ================================
  
  postgres:
    image: pgvector/pgvector:pg15
    container_name: lifestrands-postgres
    environment:
      POSTGRES_DB: lifestrands
      POSTGRES_USER: lifestrands_user
      POSTGRES_PASSWORD: ${DATABASE_PASSWORD:-lifestrands_password}
      PGDATA: /var/lib/postgresql/data/pgdata
    ports:
      - "5432:5432"
    volumes:
      - postgres-data:/var/lib/postgresql/data
      - ./database/migrations:/docker-entrypoint-initdb.d
    networks:
      - lifestrands-network
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U lifestrands_user -d lifestrands"]
      interval: 10s
      timeout: 5s
      retries: 5
    restart: unless-stopped

  redis:
    image: redis:7-alpine
    container_name: lifestrands-redis
    command: redis-server --requirepass ${REDIS_PASSWORD:-redis_password} --maxmemory 1gb --maxmemory-policy allkeys-lru
    ports:
      - "6379:6379"
    volumes:
      - redis-data:/data
    networks:
      - lifestrands-network
    healthcheck:
      test: ["CMD", "redis-cli", "--raw", "incr", "ping"]
      interval: 10s
      timeout: 3s
      retries: 5
    restart: unless-stopped

  # ================================
  # Core Application Services
  # ================================


  chat-service:
    build:
      context: ./services/chat-service
      dockerfile: Dockerfile
    container_name: lifestrands-chat-service
    environment:
      - DATABASE_URL=postgresql://lifestrands_user:${DATABASE_PASSWORD:-lifestrands_password}@postgres:5432/lifestrands
      - REDIS_URL=redis://:${REDIS_PASSWORD:-redis_password}@redis:6379
      - LM_STUDIO_BASE_URL=http://10.4.20.10:1234/v1
      - NPC_SERVICE_URL=http://npc-service:8003
      - CHAT_MODEL_ID=${CHAT_MODEL_ID:-gryphe_codex-24b-small-3.2@q5_k_l}
      - MAX_CONCURRENT_CONVERSATIONS=${MAX_CONCURRENT_CONVERSATIONS:-50}
      - CONVERSATION_TIMEOUT_MINUTES=${CONVERSATION_TIMEOUT_MINUTES:-30}
      - LOG_LEVEL=${LOG_LEVEL:-INFO}
    ports:
      - "8002:8002"
    volumes:
      - logs-data:/app/logs
    networks:
      - lifestrands-network
    extra_hosts:
      - "host.docker.internal:host-gateway"
    depends_on:
      - postgres
      - redis
    healthcheck:
      test: ["CMD", "python", "-c", "import urllib.request; urllib.request.urlopen('http://localhost:8002/health', timeout=5)"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 20s
    deploy:
      resources:
        limits:
          memory: ${CHAT_SERVICE_MEMORY_LIMIT:-2048m}
          cpus: '${CHAT_SERVICE_CPU_LIMIT:-2}'
    restart: unless-stopped

  npc-service:
    build:
      context: ./services/npc-service
      dockerfile: Dockerfile
    container_name: lifestrands-npc-service
    environment:
      - DATABASE_URL=postgresql://lifestrands_user:${DATABASE_PASSWORD:-lifestrands_password}@postgres:5432/lifestrands
      - REDIS_URL=redis://:${REDIS_PASSWORD:-redis_password}@redis:6379
      - LM_STUDIO_BASE_URL=http://10.4.20.10:1234/v1
      - ENABLE_EMBEDDINGS=${ENABLE_EMBEDDINGS:-false}
      - LOG_LEVEL=${LOG_LEVEL:-INFO}
    ports:
      - "8003:8003"
    volumes:
      - logs-data:/app/logs
    networks:
      - lifestrands-network
    depends_on:
      - postgres
      - redis
    healthcheck:
      test: ["CMD", "python", "-c", "import urllib.request; urllib.request.urlopen('http://localhost:8003/health', timeout=5)"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 20s
    deploy:
      resources:
        limits:
          memory: ${NPC_SERVICE_MEMORY_LIMIT:-2048m}
          cpus: '${NPC_SERVICE_CPU_LIMIT:-2}'
    restart: unless-stopped

  summary-service:
    build:
      context: ./services/summary-service
      dockerfile: Dockerfile
    container_name: lifestrands-summary-service
    environment:
      - DATABASE_URL=postgresql://lifestrands_user:${DATABASE_PASSWORD:-lifestrands_password}@postgres:5432/lifestrands
      - REDIS_URL=redis://:${REDIS_PASSWORD:-redis_password}@redis:6379
      - LM_STUDIO_BASE_URL=http://10.4.20.10:1234/v1
      - NPC_SERVICE_URL=http://npc-service:8003
      - SUMMARY_MODEL_ID=${SUMMARY_MODEL_ID:-gryphe_codex-24b-small-3.2@q5_k_l}
      - ANALYSIS_MODEL_ID=${ANALYSIS_MODEL_ID:-gryphe_codex-24b-small-3.2@q5_k_l}
      - SUMMARY_AUTO_APPROVAL_THRESHOLD=${SUMMARY_AUTO_APPROVAL_THRESHOLD:-0.8}
      - SUMMARY_WORKER_CONCURRENCY=${SUMMARY_WORKER_CONCURRENCY:-3}
      - LOG_LEVEL=${LOG_LEVEL:-INFO}
    ports:
      - "8004:8004"
    volumes:
      - logs-data:/app/logs
    networks:
      - lifestrands-network
    depends_on:
      - postgres
      - redis
      - npc-service
    healthcheck:
      test: ["CMD", "python", "-c", "import urllib.request; urllib.request.urlopen('http://localhost:8004/health', timeout=5)"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 20s
    deploy:
      resources:
        limits:
          memory: ${SUMMARY_SERVICE_MEMORY_LIMIT:-4096m}
          cpus: '${SUMMARY_SERVICE_CPU_LIMIT:-2}'
    restart: unless-stopped

  monitor-service:
    build:
      context: ./services/monitor-service
      dockerfile: Dockerfile
    container_name: lifestrands-monitor-service
    environment:
      - DATABASE_URL=postgresql://lifestrands_user:${DATABASE_PASSWORD:-lifestrands_password}@postgres:5432/lifestrands
      - REDIS_URL=redis://:${REDIS_PASSWORD:-redis_password}@redis:6379
      - CHAT_SERVICE_URL=http://chat-service:8002
      - NPC_SERVICE_URL=http://npc-service:8003
      - SUMMARY_SERVICE_URL=http://summary-service:8004
      - METRICS_RETENTION_DAYS=${METRICS_RETENTION_DAYS:-30}
      - ALERT_WEBHOOK=${ALERT_WEBHOOK}
      - LOG_LEVEL=${LOG_LEVEL:-INFO}
    ports:
      - "8005:8005"
    volumes:
      - logs-data:/app/logs
      - /var/run/docker.sock:/var/run/docker.sock:ro  # For container monitoring
    networks:
      - lifestrands-network
    depends_on:
      - postgres
      - redis
    healthcheck:
      test: ["CMD", "python", "-c", "import urllib.request; urllib.request.urlopen('http://localhost:8005/health', timeout=5)"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 20s
    deploy:
      resources:
        limits:
          memory: ${MONITOR_SERVICE_MEMORY_LIMIT:-1024m}
          cpus: '${MONITOR_SERVICE_CPU_LIMIT:-1}'
    restart: unless-stopped

  gateway:
    build:
      context: ./services/gateway-service
      dockerfile: Dockerfile
    container_name: lifestrands-gateway
    environment:
      - CHAT_SERVICE_URL=http://chat-service:8002
      - NPC_SERVICE_URL=http://npc-service:8003
      - SUMMARY_SERVICE_URL=http://summary-service:8004
      - MONITOR_SERVICE_URL=http://monitor-service:8005
      - JWT_SECRET=${JWT_SECRET:-your-jwt-secret-here}
      - CORS_ORIGINS=${CORS_ORIGINS:-http://localhost:3000,http://localhost:3001}
      - RATE_LIMIT_REQUESTS_PER_MINUTE=${RATE_LIMIT_REQUESTS_PER_MINUTE:-100}
      - LOG_LEVEL=${LOG_LEVEL:-INFO}
    ports:
      - "8000:8000"
    volumes:
      - logs-data:/app/logs
    networks:
      - lifestrands-network
    depends_on:
      - chat-service
      - npc-service
      - summary-service
      - monitor-service
    healthcheck:
      test: ["CMD", "python", "-c", "import urllib.request; urllib.request.urlopen('http://localhost:8000/health', timeout=5)"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 20s
    deploy:
      resources:
        limits:
          memory: ${GATEWAY_MEMORY_LIMIT:-1024m}
          cpus: '${GATEWAY_CPU_LIMIT:-2}'
    restart: unless-stopped

  # ================================
  # Supporting Services
  # ================================

  nginx:
    image: nginx:alpine
    container_name: lifestrands-nginx
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - ./nginx/nginx.conf:/etc/nginx/nginx.conf:ro
      - ./nginx/ssl:/etc/nginx/ssl:ro
      - logs-data:/var/log/nginx
    networks:
      - lifestrands-network
    depends_on:
      - gateway
    restart: unless-stopped


  # ================================
  # Development Tools (Optional)
  # ================================

  pgadmin:
    image: dpage/pgadmin4:latest
    container_name: lifestrands-pgadmin
    environment:
      - PGADMIN_DEFAULT_EMAIL=admin@example.com
      - PGADMIN_DEFAULT_PASSWORD=${PGADMIN_PASSWORD:-admin123}
      - PGADMIN_CONFIG_SERVER_MODE=False
      - PGADMIN_CONFIG_CHECK_EMAIL_DELIVERABILITY=False
    ports:
      - "8080:80"
    volumes:
      - ./pgadmin/servers.json:/pgadmin4/servers.json
    networks:
      - lifestrands-network
    depends_on:
      - postgres
    restart: unless-stopped
    profiles: ["dev-tools"]

  redis-commander:
    image: rediscommander/redis-commander:latest
    container_name: lifestrands-redis-commander
    environment:
      - REDIS_HOSTS=local:redis:6379:0:${REDIS_PASSWORD:-redis_password}
    ports:
      - "8081:8081"
    networks:
      - lifestrands-network
    depends_on:
      - redis
    restart: unless-stopped
    profiles: ["dev-tools"]

  # ================================
  # Frontend Applications (Optional)
  # ================================

  chat-interface:
    build:
      context: ./frontends/chat-interface
      dockerfile: Dockerfile
    container_name: lifestrands-chat-interface
    environment:
      - VITE_API_URL=http://localhost:8000
      - VITE_WS_URL=ws://localhost:8000
    ports:
      - "3001:3000"
    networks:
      - lifestrands-network
    depends_on:
      - gateway
    restart: unless-stopped
    profiles: ["frontend"]

  admin-dashboard:
    build:
      context: ./frontends/admin-dashboard
      dockerfile: Dockerfile
    container_name: lifestrands-admin-dashboard
    environment:
      - VITE_API_URL=http://localhost:8000
      - VITE_WS_URL=ws://localhost:8000
    ports:
      - "3002:3000"
    networks:
      - lifestrands-network
    depends_on:
      - gateway
    restart: unless-stopped
    profiles: ["frontend"]

# ================================
# Health Checks and Dependencies
# ================================

x-healthcheck-defaults: &healthcheck_defaults
  interval: 30s
  timeout: 10s
  retries: 3
  start_period: 30s
