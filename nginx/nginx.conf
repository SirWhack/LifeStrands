events {
    worker_connections 1024;
}

http {
    upstream gateway {
        server lifestrands-gateway:8000;
    }

    server {
        listen 80;
        server_name localhost;

        # API Gateway
        location /api/ {
            proxy_pass http://gateway/;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
        }

        # WebSocket support
        location /ws/ {
            proxy_pass http://gateway/ws/;
            proxy_http_version 1.1;
            proxy_set_header Upgrade $http_upgrade;
            proxy_set_header Connection "upgrade";
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
        }

        # Health check endpoint
        location /health {
            return 200 'nginx is healthy\n';
            add_header Content-Type text/plain;
        }

        # Default fallback - serve a simple message when frontends aren't available
        location / {
            return 200 '
<!DOCTYPE html>
<html>
<head><title>Life Strands - Services Only</title></head>
<body>
    <h1>Life Strands Backend Services</h1>
    <p>Frontend applications are not currently running.</p>
    <h2>Available Services:</h2>
    <ul>
        <li><a href="/api/health">API Gateway Health</a></li>
        <li><a href="http://localhost:8000">Gateway Service (8000)</a></li>
        <li><a href="http://localhost:8002">Chat Service (8002)</a></li>
        <li><a href="http://localhost:8003">NPC Service (8003)</a></li>
        <li><a href="http://localhost:8004">Summary Service (8004)</a></li>
        <li><a href="http://localhost:8005">Monitor Service (8005)</a></li>
        <li><a href="http://localhost:8080">pgAdmin (8080)</a></li>
        <li><a href="http://localhost:3000">Grafana (3000)</a></li>
    </ul>
</body>
</html>
            ';
            add_header Content-Type text/html;
        }
    }
}